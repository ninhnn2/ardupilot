# hw definition file for processing by chibios_pins.py
# X27Tek H723
# With H723 MCU, ICM-20948 9-DoF IMU (MPU-9250 Upgrade)

AUTOBUILD_TARGETS None

# default to all pins low to avoid ESD issues
DEFAULTGPIO OUTPUT LOW PULLDOWN

# MCU class and specific type
MCU STM32H7xx STM32H723xx

# board ID for firmware load
APJ_BOARD_ID AP_HW_X27TekH723

# crystal frequency
OSCILLATOR_HZ 16000000

# ChibiOS system timer
STM32_ST_USE_TIMER 2

# flash size
FLASH_SIZE_KB 1024

# USB setup
#USB_STRING_MANUFACTURER "X27Tek"

#FLASH_RESERVE_START_KB 128

# use last 2 pages for flash storage
# H723 has 8 pages of 128k each
#STORAGE_FLASH_PAGE 6

env OPTIMIZE -Os
# allow load from USB
SERIAL_ORDER OTG1 USART1

# USB
PA11 OTG_HS_DM OTG1
PA12 OTG_HS_DP OTG1

# pins for SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# USART1 is debug
PA9 USART1_TX USART1
PA10 USART1_RX USART1
#define HAL_USE_EMPTY_STORAGE 1
define HAL_STORAGE_SIZE 16384

#define HAL_SPI_CHECK_CLOCK_FREQ

# telem1
#PE8  UART7_TX UART7
#PE7  UART7_RX UART7
#PE9  UART7_RTS UART7 LOW PULLDOWN
#PE10 UART7_CTS UART7

# telem2
#PC12 UART5_TX UART5
#PD2 UART5_RX UART5
#PC8 UART5_RTS UART5 LOW PULLDOWN
#PC9 UART5_CTS UART5

# GPS1
#PB6  USART1_TX USART1
#PA10 USART1_RX USART1

# GPS2
#PE1 UART8_TX UART8
#PE0 UART8_RX UART8

# uart2 telem3
#PD5 USART2_TX USART2
#PA3 USART2_RX USART2

# debug uart
#PD8 USART3_TX USART3
#PD9 USART3_RX USART3

# ADC

#PC5 BATT_VOLTAGE_SENS ADC1 SCALE(1)
#PC4 BATT_CURRENT_SENS ADC1 SCALE(1)

#PB1 BATT2_VOLTAGE_SENS ADC1 SCALE(1)
#PA2 BATT2_CURRENT_SENS ADC1 SCALE(1)

#define HAL_BATT_VOLT_PIN 8
#define HAL_BATT_CURR_PIN 4
#define HAL_BATT_VOLT_SCALE 18.18
#define HAL_BATT_CURR_SCALE 36.36

#PA4 VDD_5V_SENS  ADC1 SCALE(2)
# CAN bus
PD0  CAN1_RX CAN1
PD1  CAN1_TX CAN1

#PD4 USART2_DE USART2
#PD5 USART2_TX USART2
#PD6 USART2_RX USART2

#PD8 USART3_TX USART3
#PD9 USART3_RX USART3
#PD12 USART3_RTS USART3
#PD11 USART3_CTS USART3

# LEDs
PG7 LED_STT1 OUTPUT OPENDRAIN HIGH
#PA5 LED_STT2 OUTPUT OPENDRAIN HIGH
define HAL_LED_ON 0

# use first LED
define HAL_GPIO_PIN_LED HAL_GPIO_PIN_LED_STT1

# Ethernet switch chip reset pin
#PD13 GPIO_ETH_RST OUTPUT HIGH PULLUP
# CAN1 standby GPIO
#PA0 GPIO_CAN_S OUTPUT LOW PULLUP

# SPI2 - ICM_20948
PB15 SPI2_MOSI SPI2
PB14 SPI2_MISO SPI2
PB13 SPI2_SCK SPI2
PB12 ICM_20948_CS CS

# SPI Device table
SPIDEV icm20948    SPI2 DEVID4  ICM_20948_CS      MODE3  4*MHZ  8*MHZ

# One IMU rotated in yaw
IMU Invensensev2 SPI:icm20948 ROTATION_ROLL_180_YAW_90

# 1 compass
COMPASS AK09916:probe_ICM20948 0 ROTATION_ROLL_180

# GPIO/PWMs
PE14 TIM1_CH4 TIM1 PWM(1) GPIO(50)
PE13 TIM1_CH3 TIM1 PWM(2) GPIO(51)
PE11 TIM1_CH2 TIM1 PWM(3) GPIO(52)
#PE9  TIM1_CH1 TIM1 PWM(4) GPIO(53)
#PD13 TIM4_CH2 TIM4 PWM(5) GPIO(54)
PD14 TIM4_CH3 TIM4 PWM(6) GPIO(55)
#PB14 TIM4_CH2 TIM4 PWM(2) GPIO(101)
#PB15 TIM4_CH3 TIM4 PWM(3) GPIO(102)

#define HAL_RCIN_THREAD_ENABLED 1
#define HAL_SCHEDULER_LOOP_DELAY_ENABLED 1
#DMA_PRIORITY SDMMC* USART6* ADC* UART* USART* SPI* TIM*

#define ALLOW_ARM_NO_COMPASS
#define HAL_PROBE_EXTERNAL_I2C_COMPASSES
#define HAL_I2C_INTERNAL_MASK 0
#define HAL_COMPASS_AUTO_ROT_DEFAULT 2
define HAL_USE_ADC FALSE

#define AP_SERIALMANAGER_REGISTER_ENABLED 1
#define AP_SCRIPTING_ENABLED 1
#define AP_FILESYSTEM_ROMFS_ENABLED 1

#define HAL_MONITOR_THREAD_ENABLED 1

#HAL_CHIBIOS_ARCH_FMUV5 1
#ROMFS io_firmware.bin Tools/IO_Firmware/iofirmware_lowpolh.bin
include ../include/minimize_features.inc
define AP_BOOTLOADER_FLASHING_ENABLED 0

